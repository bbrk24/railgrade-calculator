<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <title>Railgrade train calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet" />
    <style>
      body {
        font-family: Questrial, sans-serif;
        font-size: 1.1rem;
      }
      input {
        font: inherit;
        color: inherit;
        background-color: transparent;
        border: none;
      }
      table {
        border-spacing: 0;
      }
      td:first-child {
        padding-right: 1em;
      }
      @media (prefers-color-scheme: light) {
        tr:nth-child(odd) {
          background-color: #eee;
        }
        tr:nth-child(even) {
          background-color: gainsboro;
        }
      }
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #1c1c1c;
          color: whitesmoke;
        }
        tr:nth-child(odd) {
          background-color: #2d2d2d;
        }
        tr:nth-child(even) {
          background-color: #252525;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Railgrade train calculator</h1>
      <p>
        This page calculates some information about a train for the game Railgrade. Some information may not be 100%
        accurate, especially for larger trains.
      </p>
    </header>
    <main>
      <form onchange="reloadStats()" onkeyup="reloadStats()">
        <table>
          <tbody>
            <tr>
              <td><label for="workhorse">Workhorse Engine:</label></td>
              <td><input id="workhorse" type="number" min="0" placeholder="Enter number..." /></td>
            </tr>
            <tr>
              <td><label for="boiler">Boiler Engine:</label></td>
              <td><input id="boiler" type="number" min="0" placeholder="Enter number..." /></td>
            </tr>
            <tr>
              <td><label for="industrial">Industrial Engine:</label></td>
              <td><input id="industrial" type="number" min="0" placeholder="Enter number..." /></td>
            </tr>
            <tr>
              <td><label for="spark">Spark Engine:</label></td>
              <td><input id="spark" type="number" min="0" placeholder="Enter number..." /></td>
            </tr>
            <tr>
              <td><label for="custom">C.U.S.T.O.M. Engine:</label></td>
              <td><input id="custom" type="number" min="0" placeholder="Enter number..." /></td>
            </tr>
            <tr>
              <td><label for="rescue">RESCUE Engine:</label></td>
              <td><input id="rescue" type="number" min="0" placeholder="Enter number..." /></td>
            </tr>
            <tr>
              <td><label for="cars">Freight cars:</label></td>
              <td><input id="cars" type="number" min="0" placeholder="Enter number..." /></td>
            </tr>
          </tbody>
        </table>
      </form>
      <br />
      <div>
        Top speed: <span id="top-speed">0</span>km/h<br />
        Speed uphill: <span id="hill-speed">0</span>km/h<br />
        Initial cost: ¥<span id="cost">0</span><br />
        Upkeep: ¥<span id="upkeep">0</span>/min
        <div id="accel-info">
          Acceleration: <span id="accel">0</span>km/h/s<br />
          Time to max speed: <span id="accel-time">0</span>s
        </div>
        <div id="no-accel-info" style="display: none;">Cannot determine acceleration for mixed engine types.</div>
      </div>
    </main>
    <script>
      class Engine {
        /**
         * @param {number} costPower
         * @param {number} upkeepPower
         * @param {number} climbRating
         * @param {(carsPerEngine: number) => number} speed
         * @param {(carsPerEngine: number) => number} accel
         */
        constructor(costPower, upkeepPower, climbRating, speed, accel) {
          this.cost = 1 << (costPower + 8);
          this.upkeep = 1 << (upkeepPower + 2);
          this.climbRating = climbRating;
          this.speed = speed;
          this.accel = accel;
        }
      }

      Engine.prototype.cost = 0;
      Engine.prototype.upkeep = 0;
      Engine.prototype.climbRating = 0;
      /** @type {(carsPerEngine: number) => number} */
      Engine.prototype.speed = function speed(_) {
        throw new Error('not implemented');
      };
      /** @type {(carsPerEngine: number) => number} */
      Engine.prototype.accel = function accel(_) {
        throw new Error('not implemented');
      };

      /**
       * @param {number} x
       * @param {number} min
       * @param {number} max
       */
      function clamp(x, min, max) {
        return Math.max(min, Math.min(x, max));
      }

      // I don't actually know what the speed/acceleration formulas are.
      // These are just formulas that are accurate based on experimental data.
      const workhorse = new Engine(1, 1, 0.5, carsPerEngine => {
        if (carsPerEngine <= 2) return 50;
        if (carsPerEngine <= 4) return 54 - 2 * carsPerEngine;
        return Math.max(5, 70 - 6 * carsPerEngine);
      }, carsPerEngine => {
        if (carsPerEngine < 4) return 3.5 - carsPerEngine / 7;
        return Math.max(1/3, 4.9 - carsPerEngine / 2);
      });
      const boiler = new Engine(0, 0, 0.4, carsPerEngine => {
        if (carsPerEngine < 6) return 33 - (carsPerEngine ** 4) / 230;
        return Math.max(3, 47.7 - 3.5 * carsPerEngine);
      }, carsPerEngine => Math.max(1/3, 2.59 - 0.024 * (carsPerEngine ** 2)));
      const industrial = new Engine(
        2, 2, 0.95,
        carsPerEngine => clamp(48 - 3.5 * carsPerEngine, 3, 30),
        carsPerEngine => {
          if (carsPerEngine < 7) return 4 - carsPerEngine / 9;
          return Math.max(1/3, 5.25 - (2/7) * carsPerEngine);
        }
      );
      const spark = new Engine(3, 3, 0.5, carsPerEngine => {
        if (carsPerEngine <= 4.5) return 75;
        if (carsPerEngine <= 6) return 85 - 2 * carsPerEngine;
        if (carsPerEngine >= 8) return 112.75 - 5.5 * carsPerEngine;
        // It's mostly piecewise linear, but idk what's going on in the range (6, 8)
        // idk. Treat all points in that range as 7.
        return 71;

      }, carsPerEngine => {
        if (carsPerEngine >= 17) return 1/3;
        if (carsPerEngine > 8) return 8.9 - 0.5 * carsPerEngine;
        if (carsPerEngine < 7) return 6.2 - 0.17 * carsPerEngine;
        return 5;
      });
      const custom = new Engine(1, 1, 0.75, carsPerEngine => {
        if (carsPerEngine >= 2) return Math.max(7, 97.84 - 14.6 * carsPerEngine);
        return Math.min(75, 78.83 - 5 * carsPerEngine);
      }, carsPerEngine => {
        if (carsPerEngine > 2) return Math.max(1/3, 5.76 - carsPerEngine);
        if (carsPerEngine === 0) return 14/3
        if (carsPerEngine <= 1) return 13/3
        return 4;
      });
      const rescue = new Engine(3, 2, 1, carsPerEngine => {
        if (carsPerEngine <= 8) return 27;
        if (carsPerEngine <= 12) return 30.75 - carsPerEngine / 2;
        return 41.6 - 1.4 * carsPerEngine;
      }, carsPerEngine => {
        if (carsPerEngine < 10) return 5.04 - 0.106 * carsPerEngine;
        if (carsPerEngine <= 12) return 4;
        return 8 - carsPerEngine / 3;
      });

      const engines = { workhorse, boiler, industrial, spark, custom, rescue };

      /** @param {readonly unknown[]} arr */
      function allSame(arr) {
        let firstItem = arr[0];
        for (const item of arr) {
          if (item !== firstItem) return false;
        }
        return true;
      }

      /** @param {Record<keyof typeof engines, number | `${number}`>} obj */
      function makeArr(obj) {
        /** @type {(keyof typeof engines)[]} */
        let arr = [];
        for (const [engine, count] of Object.entries(obj)) {
          if (!+count) continue;
          for (let i = 0; i < count; ++i) arr.push(engine);
        }
        return arr;
      }

      /**
       * @template T
       * @param {readonly T[]} arr
       * @param {(arg: T) => number} f
       * @return {number}
       */
      function avg(arr, f) {
        return arr.reduce((prev, el) => prev + f(el) / arr.length, 0);
      }

      /**
       * @template T
       * @param {readonly T[]} arr
       * @param {(arg: T) => number} f
       * @return {number}
       */
      function sum(arr, f) {
        return arr.reduce((prev, el) => prev + f(el), 0);
      }

      /**
       * @param {readonly (keyof typeof engines)[]} engineNames
       * @param {number} cars
       */
      function calcStats(engineNames, cars) {
        const carsPerEngine = cars / engineNames.length;
        const engineObjects = engineNames.map(el => engines[el]);
        const topSpeed = avg(engineObjects, engine => engine.speed(carsPerEngine));

        /** @type {number | undefined} */
        let accel;
        if (engineNames.length === 0) accel = 0;
        else if (allSame(engineNames)) accel = engineObjects[0].accel(carsPerEngine);

        let accelTime = 0;
        if (accel) accelTime = topSpeed / accel;

        return {
          topSpeed: Math.round(topSpeed),
          hillSpeed: Math.round(topSpeed * avg(engineObjects, engine => engine.climbRating)),
          cost: cars * 16 + sum(engineObjects, engine => engine.cost),
          upkeep: cars + sum(engineObjects, engine => engine.upkeep),
          /** @type {number | undefined} */
          accel,
          accelTime
        };
      }

      /** @param {number} x */
      function roundThird(x) {
        const int = Math.floor(x);
        if (x - int <= 1/6) return String(int);
        if (x - int <= 1/2) return (int || '') + '&frac13;';
        if (x - int <= 5/6) return (int || '') + '&frac23;';
        return String(int + 1);
      }

      /** @param {number} x */
      function roundHalf(x) {
        const int = Math.floor(x);
        if (x - int <= 1/4) return String(int);
        if (x - int <= 3/4) return (int || '') + '&frac12;';
        return String(int + 1);
      }

      const elements = {
        /** @type {HTMLInputElement} */
        workhorse: document.getElementById('workhorse'),
        /** @type {HTMLInputElement} */
        boiler: document.getElementById('boiler'),
        /** @type {HTMLInputElement} */
        industrial: document.getElementById('industrial'),
        /** @type {HTMLInputElement} */
        spark: document.getElementById('spark'),
        /** @type {HTMLInputElement} */
        custom: document.getElementById('custom'),
        /** @type {HTMLInputElement} */
        rescue: document.getElementById('rescue'),
        /** @type {HTMLInputElement} */
        cars: document.getElementById('cars'),
        /** @type {HTMLSpanElement} */
        topSpeed: document.getElementById('top-speed'),
        /** @type {HTMLSpanElement} */
        hillSpeed: document.getElementById('hill-speed'),
        /** @type {HTMLSpanElement} */
        cost: document.getElementById('cost'),
        /** @type {HTMLSpanElement} */
        upkeep: document.getElementById('upkeep'),
        /** @type {HTMLDivElement} */
        accelInfo: document.getElementById('accel-info'),
        /** @type {HTMLDivElement} */
        noAccelInfo: document.getElementById('no-accel-info'),
        /** @type {HTMLSpanElement} */
        accel: document.getElementById('accel'),
        /** @type {HTMLSpanElement} */
        accelTime: document.getElementById('accel-time')
      };

      function reloadStats() {
        const engineCounts = {
          workhorse: elements.workhorse.value,
          boiler: elements.boiler.value,
          industrial: elements.industrial.value,
          spark: elements.spark.value,
          custom: elements.custom.value,
          rescue: elements.rescue.value
        };
        const stats = calcStats(makeArr(engineCounts), Number(elements.cars.value));
        elements.topSpeed.innerHTML = stats.topSpeed;
        elements.hillSpeed.innerHTML = stats.hillSpeed;
        elements.cost.innerHTML = stats.cost;
        elements.upkeep.innerHTML = stats.upkeep;

        if (stats.accel == null) {
          elements.accelInfo.style.display = 'none';
          elements.noAccelInfo.style.display = 'block';
        } else {
          elements.accelInfo.style.display = 'block';
          elements.noAccelInfo.style.display = 'none';

          elements.accel.innerHTML = roundThird(stats.accel);
          elements.accelTime.innerHTML = roundHalf(stats.accelTime);
        }
      }
    </script>
  </body>
</html>
